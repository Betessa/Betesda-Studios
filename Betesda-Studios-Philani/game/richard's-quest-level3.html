<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Richard's Very Bad Terrible No Good Morning</title>
    <script src="three.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/loaders/GLTFLoader.js"></script>

    <script>

        "use strict";

        var canvas, renderer, scene, camera; // Standard three.js requirements.

        var character = new THREE.Object3D(); // Will be used to store Richard and the cameras that follow him around (since he's so cool).
        var position = character.position; // Will be used to keep track of the character's position after each button press.
        var distanceBetween = new THREE.Vector3(); // Will be used to keep track of the distance between Richard and his target/goal.

        var destination3 = new THREE.Vector3(-38,0,65); // The area between MSB and MSL.
        var level = 3; // Set to the first level of the game and update where appropriate.

        var animating = false;  // Set to true when an animation is in progress.
        var frameNumber = 0;  // Frame number is advanced by 1 for each frame while animating.

        var posX = 0; // Will be used for rotating Richard while he's moving.
        var posZ = Math.PI/2; // Will be used for rotating Richard while he's moving.

        var backGroundMusic; // Will be used for all the background music used in the game.


        /**
         *  The render function draws the scene.
         */

        function render() {
            renderer.render(scene, camera);
        }

        function sound(src) { // Used to add audio and background music into the game.
            this.sound = document.createElement("audio");
            this.sound.src = src;
            this.sound.setAttribute("preload", "auto");
            this.sound.setAttribute("controls", "none");
            this.sound.style.display = "none";
            document.body.appendChild(this.sound);
            this.play = function(){
                this.sound.play();
            };
            this.stop = function(){
                this.sound.pause();
            }
        }

        function thirdLevel(){ // Will be the second state/level of the game. Update the positions of the camera and character as required.

            backGroundMusic = new sound("./assets/music-and-video/Eye of the Tiger.mp3");

            // ------------------- Make a camera with viewpoint light ----------------------

            renderer.setClearColor("white"); // Background color for scene.
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(45,canvas.width/canvas.height,0.1,200);
            var light = new THREE.DirectionalLight();   // A light shining from the direction of the camera; moves with the camera.
            light.position.set(0,0,1);
            camera.add(light);
            character.add(camera);
            scene.add(new THREE.AmbientLight(0x404040));
            scene.add(new THREE.DirectionalLight(0xffffff,0.5)); // Dim light shining from above.


            // Put the WSS (or a close approximation ;) into the game.
            const loader = new THREE.GLTFLoader(); // to load models
            loader.load('./assets/environment-objects/scene.glb',function(gltf){
                scene.add(gltf.scene);
            });

            // Put Richard into the game.
            loader.load('./assets/characters/richard.glb',function(gltf){
                gltf.scene.children[2].rotation.set(0,Math.PI,0);
                character.add(gltf.scene.children[2]);
                character.position.set(-28,0,-55);
                camera.position.set(0,3,8);
                character.add(camera);
                character.rotation.set(0,Math.PI,0);
            });
            scene.add(character);

            // Put the target (Redbull can) into the game.
            loader.load('./assets/coca-cola-bottle/coca-cola-bottle.glb',function(gltf){
                gltf.scene.position.set(-38,1,65);
                scene.add(gltf.scene);
            });
        }

        // ------------------- Initialise the timer and set it to the appropriate length ----------------------

        function CountDownTimer(duration, granularity) {
            this.duration = duration;
            this.granularity = granularity || 1000;
            this.tickFtns = [];
            this.running = false;
        }

        CountDownTimer.prototype.start = function() {
            if (this.running) {
                return;
            }
            this.running = true;
            var start = Date.now(),
                that = this,
                diff, obj;

            (function timer() {
                diff = that.duration - (((Date.now() - start) / 1000) | 0);

                if (diff > 0) {
                    setTimeout(timer, that.granularity);
                } else {
                    diff = 0;
                    that.running = false;
                }

                obj = CountDownTimer.parse(diff);
                that.tickFtns.forEach(function(ftn) {
                    ftn.call(this, obj.minutes, obj.seconds);
                }, that);
            }());
        };

        CountDownTimer.prototype.onTick = function(ftn) {
            if (typeof ftn === 'function') {
                this.tickFtns.push(ftn);
            }
            return this;
        };

        CountDownTimer.prototype.expired = function() {
            return !this.running;
        };

        CountDownTimer.parse = function(seconds) {
            return {
                'minutes': (seconds / 60) | 0,
                'seconds': (seconds % 60) | 0
            };
        };

        // Update timer and timeObj to set the timer to the appropriate length.
        window.onload = function(){
            var display = document.querySelector('#time'),
                timer = new CountDownTimer(235),
                timeObj = CountDownTimer.parse(235);

            format(timeObj.minutes, timeObj.seconds);
            timer.onTick(format);
            document.querySelector('button').addEventListener('click', function () {
                timer.start();
                animating = true;
                if (animating) {
                    requestAnimationFrame(doFrame);
                }
            });

            function format(minutes, seconds) {
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                display.textContent = minutes + ':' + seconds;
                //var run = document.getElementById("animateCheckbox").checked;
                if (minutes== 0 && seconds == 0){
                    if (confirm("Oh no! You were late for class, and now all the third years are going to fail! Do you want to restart?")) {
                        location.reload()
                    } else {
                        location.assign("./assets/music-and-video/video.mp4");
                    }
                }
            }
            init();
        };

        /**
         *  This function is called responsible for all movement within the game. After a movement
         *  is made the current position of the character is obtained and compared with the destination
         *  position of that level. Once the character has gotten to that destination position (or not)
         *  before the timer runs out, something relevant will happen.
         *
         */
        var keymap = {};
        function move(event){
            if (level == 3) { // In the third level, Richard can only make sinusoidal movements.
                if (keymap['w'] && keymap['d']){ // move forward and turn right
                    posZ += Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    character.rotateY(-Math.PI/100);
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['w'] && keymap['a']){ //move forward and turn left
                    posZ += Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    character.rotateY(Math.PI/100);
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['s'] && keymap['d']){ // move backward and turn right
                    posZ -= Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    character.rotateY(-Math.PI/100);
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['s'] && keymap['a']){ // move backward and turn left
                    posZ -= Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    character.rotateY(Math.PI/2250);
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['w']){ // move forward
                    posZ += Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['s']){ // move backward
                    posZ -= Math.PI/100;
                    character.translateZ(Math.sin(posZ));
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['a']){ // turn right
                    character.rotateY(Math.PI/100); // Was originally set to -Math.PI/100
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
                else if (keymap['d']){ // turn left
                    character.rotateY(-Math.PI/100); // Was originally set to -Math.PI/100
                    distanceBetween = position.manhattanDistanceTo(destination3);
                    if (distanceBetween < 5) {
                        console.log("hit");
                    }
                }
            }
        }

        /*  Drives the animation, called by system through requestAnimationFrame() */

        function doFrame() {
            if (animating) {
                render();
                requestAnimationFrame(doFrame);
                backGroundMusic.play(); // Plays the music
            }
        }

        /*----------------------------- INITIALIZATION ----------------------------------------
        /**
         *  This function is called by the onload event so it will run after the
         *  page has loaded.  It creates the renderer, canvas, and scene objects,
         *  calls createWorld() to add objects to the scene, and renders the
         *  initial view of the scene.  If an error occurs, it is reported.
         */
        function init() {
            try {
                canvas = document.getElementById("glcanvas");
                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: false
                });
            }
            catch (e) {
                document.getElementById("message").innerHTML="<b>Sorry, an error occurred:<br>" +
                    e + "</b>";
                return;
            }
            document.addEventListener("keydown", function(ev){keymap[ev.key] = ev.type == 'keydown';move(keymap);}, false);
            document.addEventListener("keyup",function(ev){keymap[ev.key] = ev.type == 'keydown';move(keymap);}, false);
            thirdLevel();
            render();
        }

        function changeView(el) { // This will be used to change the view from first to second person.
            if (el.value === "First Person" ){
                el.value = "Third Person";
                camera.translateZ(-7);
                camera.translateY(-1);
            }
            else{
                el.value = "First Person";
                camera.translateZ(7);
                camera.translateY(1);
            }
        }

    </script>
</head>

<body>

<h2>Richard's Very Bad Terrible No Good Morning</h2>



<noscript>
    <p style="color: #AA0000; font-weight: bold">Sorry, but this page requires JavaScript!</p>
</noscript>

<p style="color:#AA0000; font-weight: bold" id="message">
</p>
<p>
    Richard has overslept and needs to collect all the essentials and get to the CGV lecture fast!	&#128564
</p>
<p>
    <button>Start Game</button>
<div>Class starts in <span id="time"></span> but that bottle of sparkling water messed with your cognitive functions. Consequently, you can now only make sinusoidal movements. Go get that bottle of Coke Zero next to WSS to restore yourself to normal !!HURRY!</div>
<input type="button" value="First Person" onclick="return changeView(this);" />
</p>

<div id="canvas-holder" style="float:left; border: thin solid black; background-color: white">
    <canvas width=1200 height=600 id="glcanvas"></canvas>
</div>

</body>
</html>
