<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">

    <title>Richard's Very Bad Terrible No Good Morning</title>

    <script src="/scripts/three.js"></script>
    <script src="/scripts/physi.js"></script>
    <script src="/scripts/OrbitControls.js"></script>
    <script src="/scripts/GLTFLoader.js"></script>

    <script>

    "use strict";

    Physijs.scripts.worker = '/scripts/physijs_worker.js';
    Physijs.scripts.ammo = '/scripts/ammo.js';

    var initScene, render, light, canvas, renderer, scene, camera, controls, loader,character; 

    var normalMovement = true;
    var posX = 0;
    var posZ = Math.PI/2;

   window.onload = initScene = function() {
        //event listeners
        document.addEventListener("keydown", function(ev){keymap[ev.key] = ev.type == 'keydown';move(keymap);}, false);
        document.addEventListener("keyup",function(ev){keymap[ev.key] = ev.type == 'keydown';move(keymap);}, false);

        //timer initialisation
        var display = document.querySelector('#time'),
            timer = new CountDownTimer(5),
            timeObj = CountDownTimer.parse(5);

        format(timeObj.minutes, timeObj.seconds);
        
        timer.onTick(format);
        
        document.querySelector('button').addEventListener('click', function () {
            timer.start();
        });
        
        function format(minutes, seconds) {
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = minutes + ':' + seconds;
            //var run = document.getElementById("animateCheckbox").checked;
            // if (minutes== 0 && seconds == 0){
            //     if (confirm("You lost! Do you want to restart?")) {
            //       location.reload()
            //      } else {
            //         location.replace("https://www.youtube.com/watch?v=aIG0pBQw8X4")
            //         }
            // }
        }
        

        //renderer
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize( window.innerWidth, window.innerHeight - 300 );
        renderer.setClearColor("white")
		renderer.shadowMap.enabled = true;
		renderer.shadowMapSoft = true;
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );
        
        //scene
        scene = new Physijs.Scene;
		scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
		scene.addEventListener(
			'update',
			function() {
				scene.simulate( undefined, 1 );
			}
        );
        
        //camera
        camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.11,
            200
        );
        camera.rotation.set(0,Math.PI,0);
        camera.position.set(0,3,-8);

        //lights
        light = new THREE.DirectionalLight( 0xFFFFFF );
        light.position.set(0,0,1);
        light.castShadow = true;
		light.shadow.camera.left = -60;
		light.shadow.camera.right = 60;
		light.shadow.camera.bottom = 60;
		light.shadow.camera.near = 20;
		light.shadow.camera.far = 200;
		light.shadow.camera.top = -60;
		light.shadow.bias = -.0001
		light.shadow.mapSize.width = light.shadow.mapSize.height = 2048;
        light.shadow.mapSize.darkness = .7;
        scene.add( new THREE.AmbientLight( 0x404040 ) );
        scene.add( new THREE.DirectionalLight( 0xffffff, 0.5 ) );   
        
        camera.add(light);
        // character.add(camera);

        //loader
        loader = new THREE.GLTFLoader();
        //load scene
        var environment = {}
        loader.load('./assets/scene.glb',function(gltf){
            // console.log(gltf.scene)
            gltf.scene.children.forEach(function(object){
                if (object.type == 'Mesh'){
                    scene.add(new Physijs.BoxMesh(new THREE.Geometry().fromBufferGeometry(object.geometry),Physijs.createMaterial(object.material, .5, .5), 0))
                }
                else {
                    object.children.forEach(function(object){
                    scene.add(new Physijs.BoxMesh(new THREE.Geometry().fromBufferGeometry(object.geometry),Physijs.createMaterial(object.material, .5, .5), 0))
                    });
                };
            })
        }); 
        //load character
        loader.load('./assets/characters/richard.glb',function(gltf){
            character = new Physijs.CapsuleMesh(new THREE.Geometry().fromBufferGeometry(gltf.scene.children[2].children[0].children[1].geometry),gltf.scene.children[2].children[0].children[1].material,1);
            character.position.set(64,1,-47);
            character.add(camera);
            scene.add(character);
        }); 

        requestAnimationFrame( render );
		scene.simulate();
    };

    render = function() {
        requestAnimationFrame(render);
        renderer.render(scene,camera);
    };

    function CountDownTimer(duration, granularity) {
    this.duration = duration;
    this.granularity = granularity || 1000;
    this.tickFtns = [];
    this.running = false;
    }

    CountDownTimer.prototype.start = function() {
    if (this.running) {
        return;
    }
    this.running = true;
    var start = Date.now(),
        that = this,
        diff, obj;

    (function timer() {
        diff = that.duration - (((Date.now() - start) / 1000) | 0);

        if (diff > 0) {
        setTimeout(timer, that.granularity);
        } else {
        diff = 0;
        that.running = false;
        }

        obj = CountDownTimer.parse(diff);
        that.tickFtns.forEach(function(ftn) {
        ftn.call(this, obj.minutes, obj.seconds);
        }, that);
    }());
    };

    CountDownTimer.prototype.onTick = function(ftn) {
        if (typeof ftn === 'function') {
            
        
            this.tickFtns.push(ftn);
        }
        return this;
    };

    CountDownTimer.prototype.expired = function() {
        return !this.running;
    };

    CountDownTimer.parse = function(seconds) {
        return {
            'minutes': (seconds / 60) | 0,
            'seconds': (seconds % 60) | 0
        };
    };

    var keymap = {};
    function move(keymap){
        if (normalMovement == true){
            if (keymap['w'] && keymap['d']){
                character.translateZ(0.5);
                character.rotateY(-Math.PI/100);
            }
            else if (keymap['w'] && keymap['a']){
                character.translateZ(0.5);
                character.rotateY(Math.PI/100);
            }
            else if (keymap['s'] && keymap['d']){
                character.translateZ(-0.5);
                character.rotateY(-Math.PI/100);
            }
            else if (keymap['s'] && keymap['a']){
                character.translateZ(-0.5);
                character.rotateY(Math.PI/100);
            }
            else if (keymap['w']){
                character.translateZ(0.5);
            }
            else if (keymap['s']){
                character.translateZ(-0.5);
            }
            else if (keymap['a']){
                character.rotateY(Math.PI/100);
            }
            else if (keymap['d']){
                character.rotateY(-Math.PI/100);
            }
        }
        else {
            if (keymap['w'] && keymap['d']){
                posZ += Math.PI/100;
                character.translateZ(Math.sin(posZ));
                character.rotateY(-Math.PI/100);
            }
            else if (keymap['w'] && keymap['a']){
                posZ += Math.PI/100;
                character.translateZ(Math.sin(posZ));
                character.rotateY(Math.PI/100);
            }
            else if (keymap['s'] && keymap['d']){
                posZ -= Math.PI/100;
                character.translateZ(Math.sin(posZ));
                character.rotateY(Math.PI/100);
            }
            else if (keymap['s'] && keymap['a']){
                posZ -= Math.PI/100;
                character.translateZ(Math.sin(posZ));
                character.rotateY(-Math.PI/100);
            }
            else if (keymap['w']){
                posZ += Math.PI/100;
                character.translateZ(Math.sin(posZ));
            }
            else if (keymap['s']){
                posZ -= Math.PI/100;
                character.translateZ(Math.sin(posZ));
            }
            else if (keymap['a']){
                character.rotateY(-Math.PI/100);
            }
            else if (keymap['d']){
                character.rotateY(Math.PI/100);
            }
        }
    }
    </script>
</head>

<body>

<h2>Richard's Very Bad Terrible No Good Morning</h2>



<noscript>
   <p style="color: #AA0000; font-weight: bold">Sorry, but this page requires JavaScript!</p>
</noscript>

<p style="color:#AA0000; font-weight: bold" id="message">
</p>
<p>
Richard has overslept and needs to collect all the essentials and get to the CGV lecute fast!	&#128564
</p>
<p>
    <button>Start Game</button>
        <div>Class starts in <span id="time"></span> !!HURRY!</div>
   <label><input type="checkbox" id="sinMovementCheckbox"><b>Sinusoidal Movement</b></label>
   <b style="margin-left:50px">Use the mouse to rotate the model.</b>
</p>

<!-- <div id="canvas-holder" style="float:left; border: thin solid black; background-color: white">
   <canvas width=1200 height=600 id="glcanvas"></canvas>
</div> -->
<div id="viewport"></div>

</body>
</html>
